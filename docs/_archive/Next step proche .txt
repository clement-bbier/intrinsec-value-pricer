OK, on tranche.

Tu n’as pas besoin d’une usine DDD hexagonale V5 pour l’instant.
Tu n’as plus le droit non plus de rester dans le bricolage V3.

La bonne réponse, c’est une **V4.1 structurée**, inspirée de la clean architecture, avec :

* un **core math + DCF propre**,
* un **infra Yahoo + audit** clairement séparé,
* un **app/workflow** qui gère Auto vs Expert sans magie ni God object.

Je te propose ce **plan final**, clair et implémentable.

---

## 1. Architecture cible (réaliste, propre, publiable)

On part de ton repo actuel, on converge vers ça :

```text
intrinsic_value_pricer/
│
├── core/
│   ├── models.py          # DCFParameters, CompanyFinancials, DCFResult, etc.
│   ├── enums.py           # ValuationMode, FCFSource, GrowthSource...
│   ├── audit_models.py    # SubScore, AuditReport
│   └── dcf/
│       ├── discounting.py # maths pures: WACC, TV, actualisation, equity value
│       ├── engines.py     # DeterministicDCFEngine, MonteCarloEngine, HistoricalEngine
│       └── strategies.py  # SimpleStrategy, FundamentalStrategy, ManualStrategy
│
├── infra/
│   ├── data_providers/
│   │   ├── yahoo_provider.py   # remplit CompanyFinancials + DCFParameters
│   │   ├── yahoo_helpers.py
│   │   └── audit_engine.py     # Audit V4 (Data/Assumption/Stability/Mode)
│   ├── macro/
│   │   └── yahoo_macro_provider.py
│   └── ref_data/
│       └── country_matrix.py
│
├── app/
│   ├── main.py            # Streamlit entrypoint
│   ├── workflow.py        # Orchestration Auto / Expert
│   └── ui_components/
│       ├── inputs_auto.py
│       ├── inputs_expert.py
│       ├── display_kpis.py
│       ├── display_charts.py
│       └── display_audit.py
│
├── config/
│   ├── settings.yaml
│   ├── defaults.yaml      # Defaults Mode Expert
│   └── logging.conf
│
├── docs/
│   ├── methodology.md
│   ├── audit_spec_v4.md
│   └── user_manual.md
│
├── tests/
│   ├── test_discounting.py
│   ├── test_engines.py
│   ├── test_audit.py
│   └── test_workflow.py
│
├── README.md
└── requirements.txt
```

**Décisions fortes :**

* **Pas de dossier `domain/`, pas de DDD complet** → overkill pour ton contexte.
* **Pas de God Engine** → trois engines séparés, mais partageant `discounting.py`.
* **Les enums / flags vont dans `core/enums.py`**, pas dans infra.

---

## 2. Rôles clairs de chaque couche

### 2.1 `core/` = math + modèles (aucun accès à Yahoo, web, etc.)

* `models.py` :

  * `CompanyFinancials` (dataclass), avec flags structurés (`source_fcf`, `source_growth`, etc.)
  * `DCFParameters`
  * `DCFResult` (avec tous les détails numériques pour les logs/UI)
* `enums.py` :

  * `ValuationMode`
  * `FCFSource`, `GrowthSource`, etc.
* `dcf/discounting.py` :

  * `calculate_wacc`
  * `discount_cashflows`
  * `calculate_terminal_value`
  * `calculate_equity_value`
* `dcf/engines.py` :

  * `DeterministicDCFEngine` (ce qu’on a esquissé)
  * `MonteCarloEngine` (qui wrappe le deterministic)
  * `HistoricalEngine` (reconstruit VI dans le passé, en utilisant discounting)
* `dcf/strategies.py` :

  * `SimpleStrategy` (Mode 1 auto)
  * `FundamentalStrategy` (Mode 2 auto)
  * `ManualStrategy` (Mode Expert)
  * éventuellement plus tard `MultiStageStrategy` si tu veux isoler le plateau

**Règle dure :**
Core **ne devine rien**. Il ne consulte aucune source externe.
Tout ce qui est dans `DCFParameters` est considéré comme **déjà validé**.

---

### 2.2 `infra/` = Yahoo + Audit + Macro

* `yahoo_provider.py` :

  * Récupère les données brutes.
  * Nettoie, agrège, choisit FCF TTM / weighted / etc.
  * Remplit `CompanyFinancials` **+** `DCFParameters`.
  * Met les bons flags (`source_fcf = FCFSource.TTM`, etc.).
  * Ajoute des `warnings` textuels pour l’UI (mais audit ne dépend plus de ces strings).

* `audit_engine.py` :

  * Prend `CompanyFinancials`, `DCFParameters`, `simulation_results` (optionnel), `hist_coverage` (optionnel), `mode`.
  * Retourne un `AuditReport` (V4 qu’on a construit).
  * Fait la différence Auto vs Expert par un simple paramètre `mode_expert: bool` :

    * `mode_expert=False` → DataScore + AssumptionScore + Stability + ModeScore
    * `mode_expert=True` → DataScore/AssumptionScore ignorés, on garde : Stability + Mode (on peut garder un petit warning “vos hypothèses sont très éloignées des autos” si tu veux **optionnellement**, mais pas comme base de tout.)

**Règle dure :**
Infra ne fait **pas** de math DCF → pas de WACC, pas de TV. Ça, c’est core.
Infra ne fait **que** : data sourcing, mapping, audit.

---

### 2.3 `app/` = flux Auto / Expert + UI

* `workflow.py` :

  * **Mode Auto** :

    1. Appelle `YahooProvider` → `financials`, `params`
    2. Choisit la stratégie (simple / fundamental) selon l’onglet / la méthode
    3. Appelle `DeterministicDCFEngine`
    4. Si MC demandé → `MonteCarloEngine`
    5. Si historique demandé → `HistoricalEngine`
    6. Appelle `AuditEngine` avec `mode_expert=False`
    7. Passe tout ça à l’UI

  * **Mode Expert** :

    1. Récupère inputs utilisateur (rf, mrp, g, g∞, N_high, etc.)
    2. Construit `DCFParameters` à partir de ces inputs (sans provider)
    3. Crée une `ManualStrategy`
    4. Appelle `DeterministicDCFEngine` / `MonteCarloEngine`
    5. Appelle `AuditEngine` avec `mode_expert=True` (donc DataScore/AssumptionScore neutres)
    6. (Option) bouton “Comparer avec Auto” → appelle YahooProvider + deterministic engine en “shadow” et affiche seulement un panneau comparatif, **sans toucher le score de confiance**

* `ui_components/*` : affichage, pas de logique métier.

---

## 3. Logs et audit : règles strictes

Tu veux du **publable / pro**, donc :

### 3.1 Logs terminal

* Tous dans un logger structuré (`infra/logging` si tu veux, ou simple config logging.conf).
* Par convention :

```text
[DCF] ticker=AAPL mode=simple year=1 fcf=12450000.32 df=0.91 pv=11329500.29
[WACC] ticker=AAPL ke=0.112 rd=0.045 tax=0.25 we=0.82 wd=0.18 wacc=0.091
[TV] ticker=AAPL fcf_T=14500000.00 g=0.025 tv=210000000.00 tv_pv=132000000.00
[AUDIT] ticker=AAPL global=72 data=80 assumptions=65 stability=50 mode=90 mc_block=False hist_block=False
```

**Toujours avec nombres explicites**, jamais “juste du texte narratif”.

### 3.2 Audit UI

* Un widget dédié (`display_audit.py`) qui :

  * Affiche `global_score` + rating.
  * Affiche une liste des `ui_details` triés par sévérité.
  * Affiche, si mode expert, un badge :
    *“Mode Expert : la qualité des données est sous votre responsabilité. L’audit se concentre uniquement sur la stabilité du modèle et la pertinence du mode.”*

---

## 4. Auto vs Expert : règle de cohérence intellectuelle

### Mode Auto

* Score = DataScore + AssumptionScore + StabilityScore + ModeScore.
* Guardrails actifs (block MC, block historique).
* Audit = juge de la **qualité du pipeline complet**.

### Mode Expert

* Score = StabilityScore + ModeScore uniquement.
* Pas de pénalisation pour “données Yahoo pourries” → on s’en fiche, l’utilisateur a tout écrasé.
* Pas de “shadow benchmark” imposé :

  * seulement en option, sur action explicite du user (“Comparer à l’Auto”).

C’est la seule façon d’être **honnête** :

> Auto → tu juges la machine.
> Expert → tu juges la stabilité et les conséquences, pas la data source.

---

## 5. Roadmap de migration (pour ne pas exploser ton code)

Tu as déjà tout le code Phase 1 + audit V4. Voici un plan **réaliste** :

### Étape 1 – Factoriser le DCF math

* Créer `core/dcf/discounting.py`.
* Migrer les formules communes depuis `basic_engine.py`, `valuation.py`, etc.
* Adapter `basic_engine.py` pour qu’il consomme `discounting` (sans tout casser).

### Étape 2 – Introduire `DeterministicDCFEngine` + `strategies`

* Créer `core/dcf/engines.py` + `strategies.py`.
* Réimplémenter ce que fait aujourd’hui `basic_engine` dans `DeterministicDCFEngine + SimpleStrategy`.
* Faire une **passerelle temporaire** : `basic_engine` appelle simplement `DeterministicDCFEngine(SimpleStrategy)`.

### Étape 3 – Brancher `MonteCarloEngine` et `HistoricalEngine`

* Refactoriser `simulation_engine.py` vers `MonteCarloEngine` qui wrappe le deterministic.
* Refactoriser `historical_valuation_service.py` vers `HistoricalEngine` qui utilise `discounting`.

### Étape 4 – Stabiliser `YahooProvider` + `AuditEngine`

* Remplacer les strings magiques par enums/flags;
* Assurer que `AuditEngine` ne dépend plus de texte mais de `source_fcf`, `source_growth`, etc.

### Étape 5 – Ajouter Mode Expert dans `app/workflow.py` + UI

* Créer `inputs_expert.py`.
* Ajouter la bascule “Mode Expert” dans `main.py`.
* Implémenter le flux Expert dans `workflow.py` selon le schéma ci-dessus.

---

## Conclusion nette

* **Non**, ta V4.0 initiale (God Engine + Shadow Benchmark systématique) n’était pas tenable.
* **Oui**, la V4.1 que je te propose ici est **suffisamment propre, réaliste, et industrialisable** pour être publiée.
* **Non**, tu n’as pas besoin de DDD/Hexagonale complète tant que tu restes sur Yahoo & 1 dev.
* **Oui**, avec cette archi + audit V4 + Mode Expert, tu as un projet qui tient la route face à un reviewer quant / dev senior.

Si tu veux, prochain message :
on prend **ton `core/dcf/basic_engine.py` actuel** et je te montre exactement comment le transformer en `DeterministicDCFEngine + SimpleStrategy` sans tout casser.